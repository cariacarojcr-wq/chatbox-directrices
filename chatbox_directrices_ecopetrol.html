<html>
<head>
  <meta charset="utf-8"/>
  <title>Chatbox Directrices Exógena</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: url("https://ecopetrol.sharepoint.com/:i:/r/sites/DirectricesExogena/Documentos%20compartidos/fondo_ecopetrol.jpg?download=1") no-repeat center center fixed;
        background-size: cover;
    }
    h2 {
        color: #003A32;
    }
    select, button {
        padding: 10px;
        margin: 10px 0;
        width: 100%;
    }
    .response-box {
        background-color: #BFD730;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        color: #003A32;
    }
    a {
        color: #003A32;
        text-decoration: underline;
    }
  </style>
</head>
<body>

  <h2>¿Sobre qué tema quieres preguntar?</h2>
  <select id="temaSelect" onchange="loadPreguntas()">
    <option value="">-- Selecciona un tema --</option>
  </select>

  <h2>Selecciona la pregunta</h2>
  <select id="preguntaSelect" onchange="mostrarRespuesta()">
    <option value="">-- Selecciona una pregunta --</option>
  </select>

  <div class="response-box" id="respuestaContainer"></div>

  <button onclick="elevarConsulta()">No encontré mi pregunta, elevar consulta</button>

  <!-- Librería para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let chatbotData = {};

    // === 1. Cargar Excel desde SharePoint ===
    async function cargarExcel() {
        // ⚠️ Asegúrate de cambiar este enlace al correcto de tu Excel
        const url = "https://ecopetrol.sharepoint.com/sites/DirectricesExogena/Documentos%20compartidos/Matriz%20de%20directrices.xlsx";

        try {
            const response = await fetch(url, { credentials: "include" });
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data, { type: "array" });
            const hoja = workbook.Sheets[workbook.SheetNames[0]];
            const filas = XLSX.utils.sheet_to_json(hoja);

            chatbotData = {};
            filas.forEach(fila => {
                const tema = fila["Tema"];
                const pregunta = fila["Pregunta"];
                const corporativo = fila["Directriz Corporativa"] || "";
                const link = fila["Link"] || "";

                if (!chatbotData[tema]) chatbotData[tema] = {};
                if (!chatbotData[tema][pregunta]) {
                    chatbotData[tema][pregunta] = {
                        "2021": fila["Año 2021"] || "",
                        "2022": fila["Año 2022"] || "",
                        "2023": fila["Año 2023"] || "",
                        "2024": fila["Año 2024"] || "",
                        "2025": fila["Año 2025"] || "",
                        "corporativo": corporativo,
                        "link": link
                    };
                }
            });

            loadTemas();
        } catch (err) {
            document.getElementById('respuestaContainer').innerHTML =
              "<b>Error:</b> No se pudo cargar el Excel desde SharePoint.<br>" + err;
        }
    }

    // === 2. Cargar Temas ===
    function loadTemas() {
        const temaSelect = document.getElementById('temaSelect');
        temaSelect.innerHTML = '<option value="">-- Selecciona un tema --</option>';
        for (let tema in chatbotData) {
            let option = document.createElement('option');
            option.value = tema;
            option.textContent = tema;
            temaSelect.appendChild(option);
        }
    }

    // === 3. Cargar Preguntas según Tema ===
    function loadPreguntas() {
        const tema = document.getElementById('temaSelect').value;
        const preguntaSelect = document.getElementById('preguntaSelect');
        preguntaSelect.innerHTML = '<option value="">-- Selecciona una pregunta --</option>';
        if (tema && chatbotData[tema]) {
            for (let pregunta in chatbotData[tema]) {
                let option = document.createElement('option');
                option.value = pregunta;
                option.textContent = pregunta;
                preguntaSelect.appendChild(option);
            }
        }
        document.getElementById('respuestaContainer').innerHTML = '';
    }

    // === 4. Mostrar Respuesta ===
    function mostrarRespuesta() {
        const tema = document.getElementById('temaSelect').value;
        const pregunta = document.getElementById('preguntaSelect').value;
        const container = document.getElementById('respuestaContainer');

        if (tema && pregunta && chatbotData[tema][pregunta]) {
            const data = chatbotData[tema][pregunta];
            container.innerHTML = `
                <strong>Respuesta por año:</strong><br>
                <b>2021:</b> ${data['2021']}<br>
                <b>2022:</b> ${data['2022']}<br>
                <b>2023:</b> ${data['2023']}<br>
                <b>2024:</b> ${data['2024']}<br>
                <b>2025:</b> ${data['2025']}<br><br>
                <strong>Directriz Corporativa:</strong><br>${data['corporativo']}<br><br>
                <strong>Link de soporte:</strong><br>
                <a href="${data['link']}" target="_blank">${data['link']}</a>
            `;
        } else {
            container.innerHTML = '';
        }
    }

    // === 5. Botón Elevar Consulta ===
    function elevarConsulta() {
        const mailto = "mailto:walter.castro@ecopetrol.com.co?cc=adalbert.palacios@ecopetrol.com.co;sandra.bulla@ecopetrol.com.co;diana.espinosa@ecopetrol.com.co;jennyca.rodriguez@ecopetrol.com.co&subject=Consulta Directriz Exógena&body=No encontré mi pregunta en el chatbot. Por favor ayúdame.";
        window.location.href = mailto;
    }

    window.onload = cargarExcel;
  </script>
</body>
</html>
